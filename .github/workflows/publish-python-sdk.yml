name: Publish Python SDK to PyPI

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'SDK Version (e.g. 2.0.5)'
        required: true
        default: ''
  push:
    branches:
      - develop
  release:
    types: [published]

permissions:
  contents: write

jobs:
  publish-python-sdk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Speakeasy CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          else
            # Fetch latest version from PyPI and increment patch version
            echo "ðŸ“¡ Fetching latest version from PyPI..."
            LATEST_VERSION=$(curl -s https://pypi.org/pypi/flexprice-sdk-test/json | grep -o '"version":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
            
            if [ -z "$LATEST_VERSION" ]; then
              # No version found on PyPI, start with 2.0.0
              VERSION="2.0.0"
              echo "âš ï¸  No previous version found on PyPI, starting with $VERSION"
            else
              echo "Latest version: $LATEST_VERSION"
              # Extract major, minor, patch
              MAJOR=$(echo $LATEST_VERSION | cut -d. -f1)
              MINOR=$(echo $LATEST_VERSION | cut -d. -f2)
              PATCH=$(echo $LATEST_VERSION | cut -d. -f3)
              
              # Check if PATCH is a valid number (not timestamp)
              if [[ "$PATCH" =~ ^[0-9]{1,3}$ ]]; then
                # Valid patch number (1-3 digits), increment it
                NEW_PATCH=$((PATCH + 1))
                VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
                echo "ðŸ”¼ Incrementing patch version: $LATEST_VERSION â†’ $VERSION"
              else
                # Patch is timestamp or invalid, reset to 2.0.0
                VERSION="2.0.0"
                echo "âš ï¸  Previous version uses timestamp format ($LATEST_VERSION), resetting to $VERSION"
              fi
            fi
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "ðŸ“¦ Publishing Python SDK version: ${VERSION}"

      - name: Update version in gen.yaml
        run: |
          sed -i '/^python:/,/^[a-z]/ { /^  version:/ s/version: .*/version: ${{ env.VERSION }}/; }' .speakeasy/gen.yaml
          echo "âœ“ Updated Python SDK version to ${{ env.VERSION }}"

      - name: Generate Swagger
        run: |
          if [ -f "Makefile" ] && grep -q "swagger" Makefile; then
            echo "ðŸ”¨ Generating Swagger..."
            make swagger || echo "âš ï¸ Swagger generation skipped"
          fi

      - name: Generate Python SDK with Speakeasy
        env:
          SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
        run: |
          echo "ðŸ”¨ Generating Python SDK..."
          /usr/local/bin/speakeasy run --target flexprice-python
          echo "âœ“ Python SDK generated"

      - name: Copy custom files to SDK
        run: |
          echo "ðŸ“‹ Copying custom files..."
          if [ -f "api/custom/python/async_utils.py" ]; then
            mkdir -p api/python/src/flexprice_sdk_test
            cp api/custom/python/async_utils.py api/python/src/flexprice_sdk_test/
            echo "âœ“ Copied async_utils.py"
          fi

      - name: Fix pyproject.toml for proper packaging
        working-directory: api/python
        run: |
          echo "ðŸ“ Fixing pyproject.toml for proper packaging..."
          
          # Fix README reference if needed
          if [ ! -f "README-PYPI.md" ] && [ -f "README.md" ]; then
            sed -i 's/readme = "README-PYPI.md"/readme = "README.md"/' pyproject.toml || true
            echo "âœ“ Fixed README reference to README.md"
          fi
          
          echo "âœ“ pyproject.toml ready for packaging"

      - name: Update version in pyproject.toml
        working-directory: api/python
        run: |
          echo "ðŸ“ Updating version in pyproject.toml..."
          sed -i "s/^version = \".*\"/version = \"${{ env.VERSION }}\"/" pyproject.toml
          echo "âœ“ Version updated to ${{ env.VERSION }}"

      - name: Install build tools
        run: |
          echo "ðŸ“¦ Installing build tools..."
          pip install --upgrade build twine
          echo "âœ“ Build tools installed"

      - name: Build package
        working-directory: api/python
        run: |
          echo "ðŸ—ï¸ Building package with setuptools..."
          python -m build
          echo "âœ“ Package built successfully"

      - name: Verify package contents
        working-directory: api/python
        run: |
          echo "ðŸ§ª Verifying package contents..."
          ls -lh dist/
          echo ""
          echo "Checking wheel contents:"
          unzip -l dist/*.whl | head -30 || true
          echo "âœ“ Package verified"

      - name: Publish to PyPI
        working-directory: api/python
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: |
          echo "ðŸš€ Publishing to PyPI..."
          python -m twine upload dist/*
          echo "âœ… Python SDK v${{ env.VERSION }} published successfully to PyPI!"
          echo "ðŸ”— Package: https://pypi.org/project/flexprice-sdk-test/"

      - name: Clone python-sdk-temp repository
        run: |
          echo "ðŸ“¥ Cloning python-sdk-temp repository..."
          git clone https://x-access-token:${{ secrets.SDK_DEPLOY_GIT_TOKEN }}@github.com/flexprice/python-sdk-temp.git /tmp/python-sdk
          echo "âœ“ Repository cloned"

      - name: Copy SDK files to python-sdk-temp
        run: |
          echo "ðŸ“ Copying SDK files..."

          cd /tmp/python-sdk

          # Remove old files (except .git)
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          # Copy SDK files
          cp -r $GITHUB_WORKSPACE/api/python/* /tmp/python-sdk/

          # Copy LICENSE
          if [ -f "$GITHUB_WORKSPACE/LICENSE" ]; then
            cp $GITHUB_WORKSPACE/LICENSE /tmp/python-sdk/
          fi

          echo "âœ“ Files copied"

      - name: Commit and push to python-sdk-temp
        run: |
          cd /tmp/python-sdk

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Check for changes
          if [ -z "$(git status --porcelain)" ]; then
            echo "âš ï¸ No changes to commit"
            exit 0
          fi

          # Stage and commit
          git add .
          git commit -m "Release Python SDK v${{ env.VERSION }}"

          # Create tag
          git tag -a "v${{ env.VERSION }}" -m "Python SDK version ${{ env.VERSION }}"

          # Push
          git push origin main
          git push origin "v${{ env.VERSION }}"

          echo "âœ… Python SDK v${{ env.VERSION }} pushed to repository!"
          echo "ðŸ”— Repository: https://github.com/flexprice/python-sdk-temp"
          echo "ðŸ·ï¸ Tag: v${{ env.VERSION }}"

      - name: Summary
        if: success()
        run: |
          echo "## âœ… Python SDK Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**PyPI:** https://pypi.org/project/flexprice-sdk-test/" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** https://github.com/flexprice/python-sdk-temp" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** v${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "pip install flexprice-sdk-test==${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

