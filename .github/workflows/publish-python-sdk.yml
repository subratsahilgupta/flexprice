name: Publish Python SDK to PyPI

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  publish-python-sdk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Speakeasy CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh

      - name: Get version from release tag
        id: get_version
        run: |
          # Extract version from release tag (e.g., v1.0.48 -> 1.0.48)
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "üì¶ Publishing Python SDK version: ${VERSION}"

      - name: Update version in gen.yaml
        run: |
          sed -i '/^python:/,/^[a-z]/ { /^  version:/ s/version: .*/version: ${{ env.VERSION }}/; }' .speakeasy/gen.yaml
          echo "‚úì Updated Python SDK version to ${{ env.VERSION }}"

      - name: Generate Swagger
        run: |
          echo "üî® Generating Swagger..."
          make swagger
          
          if [ ! -f "docs/swagger/swagger-3-0.json" ]; then
            echo "‚ùå ERROR: Swagger file not found at docs/swagger/swagger-3-0.json"
            exit 1
          fi
          
          echo "‚úì Swagger generated successfully"
          echo "üìÑ Swagger file size: $(wc -c < docs/swagger/swagger-3-0.json) bytes"

      - name: Clean Python SDK directory
        run: |
          echo "üßπ Cleaning old Python SDK files..."
          rm -rf api/python
          echo "‚úì Cleaned api/python directory"

      - name: Generate Python SDK with Speakeasy
        env:
          SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
        run: |
          echo "üî® Generating Python SDK..."
          /usr/local/bin/speakeasy run --target flexprice-python
          echo "‚úì Python SDK generated"
          
      - name: Verify Python SDK structure
        run: |
          echo "üîç Verifying Python SDK structure..."
          
          if [ ! -d "api/python/src/flexprice_sdk_test" ]; then
            echo "‚ùå ERROR: api/python/src/flexprice_sdk_test/ directory not found"
            echo "Directory contents:"
            ls -la api/python/
            if [ -d "api/python/src" ]; then
              echo "src/ contents:"
              ls -la api/python/src/
            fi
            exit 1
          fi
          
          if [ ! -f "api/python/src/flexprice_sdk_test/__init__.py" ]; then
            echo "‚ùå ERROR: api/python/src/flexprice_sdk_test/__init__.py not found"
            ls -la api/python/src/flexprice_sdk_test/
            exit 1
          fi
          
          echo "‚úì Python SDK structure verified"
          echo "üì¶ Package structure:"
          ls -la api/python/src/flexprice_sdk_test/ | head -10
          
      - name: Fix build system configuration
        working-directory: api/python
        run: |
          echo "üîß Ensuring correct build system..."
          
          # Remove poetry.lock if it exists (causes build system confusion)
          if [ -f "poetry.lock" ]; then
            rm poetry.lock
            echo "‚úì Removed poetry.lock"
          fi
          
          # Ensure pyproject.toml uses setuptools (not poetry)
          if grep -q "poetry-core" pyproject.toml; then
            echo "‚ö†Ô∏è Found poetry-core in pyproject.toml, fixing..."
            sed -i 's/poetry-core/setuptools>=61.0/' pyproject.toml
            sed -i 's/poetry\.core\.masonry\.api/setuptools.build_meta/' pyproject.toml
          fi
          
          echo "‚úì Build system configuration verified"

      - name: Copy custom files to SDK
        run: |
          echo "üìã Copying custom files to Python SDK..."
          
          COPIED=0
          
          # Copy examples folder
          if [ -d "api/custom/python/examples" ] && [ "$(ls -A api/custom/python/examples 2>/dev/null)" ]; then
            mkdir -p api/python/examples
            cp -r api/custom/python/examples/* api/python/examples/ 2>/dev/null || true
            FILE_COUNT=$(ls -1 api/custom/python/examples 2>/dev/null | wc -l | tr -d ' ')
            echo "‚úì Copied examples folder ($FILE_COUNT files)"
            COPIED=$((COPIED + 1))
          else
            echo "‚è≠Ô∏è  Skipping: No examples found in api/custom/python/examples/"
          fi
          
          # Copy async_utils.py if it exists
          if [ -f "api/custom/python/async_utils.py" ]; then
            mkdir -p api/python/src/flexprice_sdk_test
            cp api/custom/python/async_utils.py api/python/src/flexprice_sdk_test/ 2>/dev/null || true
            echo "‚úì Copied async_utils.py"
            COPIED=$((COPIED + 1))
          else
            echo "‚è≠Ô∏è  Skipping: async_utils.py not found"
          fi
          
          # Copy any other custom Python files
          if [ -d "api/custom/python/utils" ] && [ "$(ls -A api/custom/python/utils 2>/dev/null)" ]; then
            mkdir -p api/python/src/flexprice_sdk_test/utils
            cp -r api/custom/python/utils/* api/python/src/flexprice_sdk_test/utils/ 2>/dev/null || true
            echo "‚úì Copied utils folder"
            COPIED=$((COPIED + 1))
          else
            echo "‚è≠Ô∏è  Skipping: No utils found in api/custom/python/utils/"
          fi
          
          if [ $COPIED -eq 0 ]; then
            echo "‚ÑπÔ∏è  No custom files found to copy - SDK will use only Speakeasy-generated files"
          else
            echo "‚úÖ Successfully copied $COPIED custom file(s)/folder(s)"
          fi

      - name: Fix pyproject.toml for proper packaging
        working-directory: api/python
        run: |
          echo "üìù Fixing pyproject.toml for proper packaging..."
          
          # Fix README reference if needed
          if [ ! -f "README-PYPI.md" ] && [ -f "README.md" ]; then
            sed -i 's/readme = "README-PYPI.md"/readme = "README.md"/' pyproject.toml || true
            echo "‚úì Fixed README reference to README.md"
          fi
          
          echo "‚úì pyproject.toml ready for packaging"

      - name: Update version in pyproject.toml
        working-directory: api/python
        run: |
          echo "üìù Updating version in pyproject.toml..."
          sed -i "s/^version = \".*\"/version = \"${{ env.VERSION }}\"/" pyproject.toml
          echo "‚úì Version updated to ${{ env.VERSION }}"

      - name: Install build tools
        run: |
          echo "üì¶ Installing build tools..."
          pip install --upgrade build twine
          echo "‚úì Build tools installed"

      - name: Build package
        working-directory: api/python
        run: |
          echo "üèóÔ∏è Building package with setuptools..."
          python -m build
          echo "‚úì Package built successfully"

      - name: Verify package contents
        working-directory: api/python
        run: |
          echo "üß™ Verifying package contents..."
          ls -lh dist/
          echo ""
          echo "Checking wheel contents:"
          unzip -l dist/*.whl | head -30 || true
          echo "‚úì Package verified"

      - name: Publish to PyPI
        working-directory: api/python
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: |
          echo "üöÄ Publishing to PyPI..."
          python -m twine upload dist/*
          echo "‚úÖ Python SDK v${{ env.VERSION }} published successfully to PyPI!"
          echo "üîó Package: https://pypi.org/project/flexprice-sdk-test/"

      - name: Clone python-sdk-temp repository
        run: |
          echo "üì• Cloning python-sdk-temp repository..."
          git clone https://x-access-token:${{ secrets.SDK_DEPLOY_GIT_TOKEN }}@github.com/flexprice/python-sdk-temp.git /tmp/python-sdk
          echo "‚úì Repository cloned"

      - name: Copy SDK files to python-sdk-temp
        run: |
          echo "üìÅ Copying SDK files..."

          cd /tmp/python-sdk

          # Remove old files (except .git)
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          # Copy SDK files
          cp -r $GITHUB_WORKSPACE/api/python/* /tmp/python-sdk/

          # Copy LICENSE
          if [ -f "$GITHUB_WORKSPACE/LICENSE" ]; then
            cp $GITHUB_WORKSPACE/LICENSE /tmp/python-sdk/
          fi

          echo "‚úì Files copied"

      - name: Commit and push to python-sdk-temp
        run: |
          cd /tmp/python-sdk

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Check for changes
          if [ -z "$(git status --porcelain)" ]; then
            echo "‚ö†Ô∏è No changes to commit"
            exit 0
          fi

          # Stage and commit
          git add .
          git commit -m "Release Python SDK v${{ env.VERSION }}"

          # Create tag
          git tag -a "v${{ env.VERSION }}" -m "Python SDK version ${{ env.VERSION }}"

          # Push
          git push origin main
          git push origin "v${{ env.VERSION }}"

          echo "‚úÖ Python SDK v${{ env.VERSION }} pushed to repository!"
          echo "üîó Repository: https://github.com/flexprice/python-sdk-temp"
          echo "üè∑Ô∏è Tag: v${{ env.VERSION }}"

      - name: Summary
        if: success()
        run: |
          echo "## ‚úÖ Python SDK Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**PyPI:** https://pypi.org/project/flexprice-sdk-test/" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** https://github.com/flexprice/python-sdk-temp" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** v${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "pip install flexprice-sdk-test==${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

