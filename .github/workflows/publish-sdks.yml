name: Publish SDKs (Go, Python, TypeScript)

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      force:
        description: Force regeneration
        type: boolean
        required: false
        default: false
      go_version:
        description: 'Go SDK version (leave empty for auto: 2.0.YYYYMMDDHHMMSS)'
        required: false
        type: string
      python_version:
        description: 'Python SDK version (leave empty for auto: 2.0.0)'
        required: false
        type: string
      typescript_version:
        description: 'TypeScript SDK version (leave empty for auto: 2.0.0)'
        required: false
        type: string

jobs:
  generate-sdks:
    name: Generate All SDKs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Speakeasy
        uses: speakeasy-api/sdk-generation-action@v15
        with:
          speakeasy_api_key: ${{ secrets.SPEAKEASY_API_KEY }}

      - name: Generate Go SDK version
        id: go_version
        run: |
          if [ -n "${{ github.event.inputs.go_version }}" ]; then
            VERSION="${{ github.event.inputs.go_version }}"
          else
            VERSION="2.0.$(date -u +%Y%m%d%H%M%S)"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "üì¶ Go SDK version: ${VERSION}"

      - name: Generate Python SDK version
        id: python_version
        run: |
          if [ -n "${{ github.event.inputs.python_version }}" ]; then
            VERSION="${{ github.event.inputs.python_version }}"
          else
            VERSION="2.0.0"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "üì¶ Python SDK version: ${VERSION}"

      - name: Generate TypeScript SDK version
        id: typescript_version
        run: |
          if [ -n "${{ github.event.inputs.typescript_version }}" ]; then
            VERSION="${{ github.event.inputs.typescript_version }}"
          else
            VERSION="2.0.0"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "üì¶ TypeScript SDK version: ${VERSION}"

      - name: Update Go SDK version in gen.yaml
        run: |
          sed -i "s/^    version: .*/    version: ${{ steps.go_version.outputs.version }}/" .speakeasy/gen.yaml

      - name: Update Python SDK version in gen-python.yaml
        run: |
          sed -i "s/^    version: .*/    version: ${{ steps.python_version.outputs.version }}/" .speakeasy/gen-python.yaml

      - name: Update TypeScript SDK version in gen-typescript.yaml
        run: |
          sed -i "s/^    version: .*/    version: ${{ steps.typescript_version.outputs.version }}/" .speakeasy/gen-typescript.yaml

      - name: Generate SDKs
        env:
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          speakeasy run

      - name: Copy custom files to all SDKs
        run: |
          echo "üîç Copying custom files to all generated SDKs..."
          
          # Copy Go custom files
          echo "üì¶ Copying Go custom files..."
          ./scripts/copy-custom-files.sh go || echo "‚ö†Ô∏è Warning: Go custom files copy had issues"
          
          # Copy Python custom files
          echo "üì¶ Copying Python custom files..."
          ./scripts/copy-custom-files.sh python || echo "‚ö†Ô∏è Warning: Python custom files copy had issues"
          
          # Copy JavaScript custom files  
          echo "üì¶ Copying JavaScript custom files..."
          ./scripts/copy-custom-files.sh javascript || echo "‚ö†Ô∏è Warning: JavaScript custom files copy had issues"
          
          echo "‚úÖ All custom files copied"

      - name: Upload Go SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-sdk
          path: api/go/

  publish-go:
    name: Publish Go SDK to GitHub
    needs: generate-sdks
    runs-on: ubuntu-latest
    steps:
      - name: Download Go SDK artifact
        uses: actions/download-artifact@v4
        with:
          name: go-sdk
          path: sdk/

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Clone and update Go SDK repo
        run: |
          git clone https://x-access-token:${{ secrets.SDK_DEPLOY_GIT_TOKEN }}@github.com/flexprice/go-sdk-temp.git repo
          cd repo
          
          # Remove all files except .git
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          
          # Copy new SDK files
          cp -r ../sdk/* .
          
          # Stage all changes
          git add -A
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "üì≠ No changes to commit"
            exit 0
          fi
          
          # Commit and push
          git commit -m "chore: Update Go SDK via Speakeasy"
          
          # Get version from gen.yaml
          VERSION=$(grep "^    version:" ../.speakeasy/gen.yaml | awk '{print $2}')
          
          # Create and push tag
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin main
          git push origin "v${VERSION}"
          
          echo "‚úÖ Go SDK published: v${VERSION}"

