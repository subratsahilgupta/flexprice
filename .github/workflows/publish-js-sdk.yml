name: Publish JavaScript SDK to npm

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  publish-js-sdk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install Speakeasy CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh

      - name: Get version from release tag
        id: get_version
        run: |
          # Extract version from release tag (e.g., v1.0.48 -> 1.0.48)
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "ğŸ“¦ Publishing JavaScript SDK version: ${VERSION}"

      - name: Update version in gen.yaml
        run: |
          sed -i '/^typescript:/,/^[a-z]/ { /^  version:/ s/version: .*/version: ${{ env.VERSION }}/; }' .speakeasy/gen.yaml
          echo "âœ“ Updated TypeScript SDK version to ${{ env.VERSION }}"

      - name: Generate Swagger
        run: |
          echo "ğŸ”¨ Generating Swagger..."
          make swagger
          
          if [ ! -f "docs/swagger/swagger-3-0.json" ]; then
            echo "âŒ ERROR: Swagger file not found at docs/swagger/swagger-3-0.json"
            exit 1
          fi
          
          echo "âœ“ Swagger generated successfully"
          echo "ğŸ“„ Swagger file size: $(wc -c < docs/swagger/swagger-3-0.json) bytes"

      - name: Generate JavaScript SDK with Speakeasy
        env:
          SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
        run: |
          echo "ğŸ”¨ Generating JavaScript/TypeScript SDK..."
          /usr/local/bin/speakeasy run --target flexprice-typescript
          echo "âœ“ JavaScript SDK generated"

      - name: Remove incompatible custom files
        working-directory: api/javascript
        run: |
          echo "ğŸ“‹ Cleaning up incompatible custom files..."
          
          # Remove CustomerPortal.ts - it was written for old OpenAPI Generator structure
          # and is incompatible with new Speakeasy SDK structure
          # TODO: Rewrite CustomerPortal for Speakeasy SDK structure
          if [ -f "src/apis/CustomerPortal.ts" ]; then
            rm -f src/apis/CustomerPortal.ts
            echo "âœ“ Removed incompatible CustomerPortal.ts (needs rewrite for Speakeasy)"
          fi
          
          # Remove empty apis directory if it exists
          if [ -d "src/apis" ] && [ -z "$(ls -A src/apis)" ]; then
            rmdir src/apis
            echo "âœ“ Removed empty src/apis directory"
          fi
          
          echo "ğŸ“ Current SDK structure:"
          ls -la src/ || true

      - name: Update version in package.json
        working-directory: api/javascript
        run: |
          echo "ğŸ“ Updating version in package.json..."
          # Use sed to update version directly
          sed -i "s/\"version\": \".*\"/\"version\": \"${{ env.VERSION }}\"/" package.json
          echo "âœ“ Version updated to ${{ env.VERSION }}"
          cat package.json | grep version

      - name: Install dependencies and build
        working-directory: api/javascript
        run: |
          echo "ğŸ”¨ Installing dependencies..."
          npm ci
          echo "ğŸ—ï¸ Building package..."
          npm run build
          echo "âœ“ Package built successfully"

      - name: Verify package
        working-directory: api/javascript
        run: |
          echo "ğŸ§ª Verifying package..."
          ls -lh
          echo "âœ“ Package verified"

      - name: Publish to npm
        working-directory: api/javascript
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "ğŸš€ Publishing to npm..."
          npm publish --access public
          echo "âœ… JavaScript SDK v${{ env.VERSION }} published successfully to npm!"
          echo "ğŸ”— Package: https://www.npmjs.com/package/flexprice-sdk-test"

      - name: Clone js-sdk-temp repository
        run: |
          echo "ğŸ“¥ Cloning js-sdk-temp repository..."
          git clone https://x-access-token:${{ secrets.SDK_DEPLOY_GIT_TOKEN }}@github.com/flexprice/js-sdk-temp.git /tmp/js-sdk
          echo "âœ“ Repository cloned"

      - name: Copy SDK files to js-sdk-temp
        run: |
          echo "ğŸ“ Copying SDK files..."

          cd /tmp/js-sdk

          # Remove old files (except .git)
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +

          # Copy SDK files
          cp -r $GITHUB_WORKSPACE/api/javascript/* /tmp/js-sdk/

          # Copy LICENSE
          if [ -f "$GITHUB_WORKSPACE/LICENSE" ]; then
            cp $GITHUB_WORKSPACE/LICENSE /tmp/js-sdk/
          fi

          echo "âœ“ Files copied"

      - name: Commit and push to js-sdk-temp
        run: |
          cd /tmp/js-sdk

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Check for changes
          if [ -z "$(git status --porcelain)" ]; then
            echo "âš ï¸ No changes to commit"
            exit 0
          fi

          # Stage and commit
          git add .
          git commit -m "Release JavaScript SDK v${{ env.VERSION }}"

          # Create tag
          git tag -a "v${{ env.VERSION }}" -m "JavaScript SDK version ${{ env.VERSION }}"

          # Push
          git push origin main
          git push origin "v${{ env.VERSION }}"

          echo "âœ… JavaScript SDK v${{ env.VERSION }} pushed to repository!"
          echo "ğŸ”— Repository: https://github.com/flexprice/js-sdk-temp"
          echo "ğŸ·ï¸ Tag: v${{ env.VERSION }}"

      - name: Summary
        if: success()
        run: |
          echo "## âœ… JavaScript SDK Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**npm:** https://www.npmjs.com/package/flexprice-sdk-test" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** https://github.com/flexprice/js-sdk-temp" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** v${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "npm install flexprice-sdk-test@${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

