name: Publish Go SDK Only

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'SDK Version (e.g. 1.0.5)'
        required: true
        default: ''

permissions:
  contents: write

jobs:
  publish-go-sdk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          
      - name: Setup Speakeasy
        uses: speakeasy-api/sdk-generation-action@v15
        env:
          SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
        with:
          speakeasy_version: latest
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Authenticate Speakeasy
        env:
          SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
        run: |
          speakeasy auth login --api-key $SPEAKEASY_API_KEY
          
      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "ðŸ“¦ Publishing Go SDK version: ${VERSION}"
          
      - name: Update version in gen.yaml
        run: |
          # Update Go SDK version
          sed -i 's/^go:/&\n  version: ${{ env.VERSION }}/' .speakeasy/gen.yaml || \
          sed -i '/^go:/,/^[a-z]/s/version: .*/version: ${{ env.VERSION }}/' .speakeasy/gen.yaml
          
          echo "âœ“ Updated version in gen.yaml"
          grep -A 5 "^go:" .speakeasy/gen.yaml
          
      - name: Generate Swagger (if needed)
        run: |
          # Check if swagger generation is needed
          if [ -f "Makefile" ] && grep -q "swagger" Makefile; then
            echo "Generating Swagger..."
            make swagger || echo "âš ï¸  Swagger generation skipped"
          fi
          
      - name: Generate Go SDK
        run: |
          echo "ðŸ”¨ Generating Go SDK with Speakeasy..."
          speakeasy run --target flexprice-go
          
          echo "âœ“ Go SDK generated"
          ls -lah api/go/
          
      - name: Copy custom files to SDK
        run: |
          echo "ðŸ“‹ Copying custom files from api/custom/go/ to api/go/..."
          
          # Copy custom Go files (helpers.go, async.go)
          if [ -f "api/custom/go/helpers.go" ]; then
            cp api/custom/go/helpers.go api/go/
            echo "âœ“ Copied helpers.go"
          fi
          
          if [ -f "api/custom/go/async.go" ]; then
            cp api/custom/go/async.go api/go/
            echo "âœ“ Copied async.go"
          fi
          
          # Copy examples directory
          if [ -d "api/custom/go/examples" ]; then
            cp -r api/custom/go/examples api/go/
            echo "âœ“ Copied examples/"
          fi
          
          echo "âœ… Custom files copied successfully"
          
      - name: Verify Go SDK builds
        working-directory: api/go
        run: |
          echo "ðŸ§ª Testing Go SDK compilation..."
          go mod tidy
          go build ./...
          echo "âœ“ Go SDK compiles successfully"
          
      - name: Clone go-sdk-temp repository
        run: |
          echo "ðŸ“¥ Cloning go-sdk-temp repository..."
          git clone https://x-access-token:${{ secrets.SDK_DEPLOY_GIT_TOKEN }}@github.com/flexprice/go-sdk-temp.git /tmp/go-sdk
          echo "âœ“ Repository cloned"
          
      - name: Copy SDK files to go-sdk-temp
        run: |
          echo "ðŸ“ Copying SDK files..."
          
          # Remove old files (except .git)
          cd /tmp/go-sdk
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          
          # Copy new SDK files
          cp -r $GITHUB_WORKSPACE/api/go/* /tmp/go-sdk/
          
          # Copy LICENSE if exists
          if [ -f "$GITHUB_WORKSPACE/LICENSE" ]; then
            cp $GITHUB_WORKSPACE/LICENSE /tmp/go-sdk/
          fi
          
          echo "âœ“ Files copied"
          ls -lah /tmp/go-sdk/ | head -20
          
      - name: Commit and push to go-sdk-temp
        run: |
          cd /tmp/go-sdk
          
          # Configure git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Check for changes
          if [ -z "$(git status --porcelain)" ]; then
            echo "âš ï¸  No changes to commit"
          else
            # Stage all changes
            git add .
            
            # Commit
            git commit -m "chore: Update Go SDK to version ${{ env.VERSION }}" \
                       -m "Generated by Speakeasy" \
                       -m "Source: ${{ github.repository }}@${{ github.sha }}"
            
            echo "âœ“ Changes committed"
          fi
          
          # Create and push tag
          if git rev-parse "v${{ env.VERSION }}" >/dev/null 2>&1; then
            echo "âš ï¸  Tag v${{ env.VERSION }} already exists, skipping tag creation"
          else
            git tag -a "v${{ env.VERSION }}" -m "Release version ${{ env.VERSION }}"
            echo "âœ“ Tag v${{ env.VERSION }} created"
          fi
          
          # Push changes and tags
          echo "ðŸš€ Pushing to go-sdk-temp..."
          git push origin main
          git push origin --tags
          
          echo "âœ… Go SDK published to https://github.com/flexprice/go-sdk-temp"
          echo "ðŸ“¦ Version: v${{ env.VERSION }}"
          echo "ðŸ”— Import path: github.com/flexprice/go-sdk-temp"
          
      - name: Create release summary
        run: |
          echo "## ðŸ“¦ Go SDK Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`v${{ env.VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** https://github.com/flexprice/go-sdk-temp" >> $GITHUB_STEP_SUMMARY
          echo "**Import path:** \`github.com/flexprice/go-sdk-temp\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "go get github.com/flexprice/go-sdk-temp@v${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

