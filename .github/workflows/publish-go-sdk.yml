name: Publish Go SDK to go-sdk-temp

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  publish-go-sdk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          
      - name: Install Speakeasy CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh
          
      - name: Get version from release tag
        id: get_version
        run: |
          # Extract version from release tag (e.g., v1.0.48 -> 1.0.48)
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "üì¶ Publishing Go SDK version: ${VERSION}"
          
      - name: Update version in gen.yaml
        run: |
          # Update Go SDK version in gen.yaml
          sed -i '/^go:/,/^[a-z]/ { /^  version:/ s/version: .*/version: ${{ env.VERSION }}/; }' .speakeasy/gen.yaml
          echo "‚úì Updated Go SDK version to ${{ env.VERSION }}"
          
      - name: Generate Swagger
        run: |
          echo "üî® Generating Swagger..."
          make swagger
          
          if [ ! -f "docs/swagger/swagger-3-0.json" ]; then
            echo "‚ùå ERROR: Swagger file not found at docs/swagger/swagger-3-0.json"
            exit 1
          fi
          
          echo "‚úì Swagger generated successfully"
          echo "üìÑ Swagger file size: $(wc -c < docs/swagger/swagger-3-0.json) bytes"
          
      - name: Clean Go SDK directory
        run: |
          echo "üßπ Cleaning old Go SDK files..."
          rm -rf api/go
          echo "‚úì Cleaned api/go directory"
          
      - name: Generate Go SDK with Speakeasy
        env:
          SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
        run: |
          echo "üî® Generating Go SDK..."
          /usr/local/bin/speakeasy run --target flexprice-go
          echo "‚úì Go SDK generated"
          
      - name: Copy custom files to SDK
        run: |
          echo "üìã Copying custom files..."
          make speakeasy-copy-go-custom
          
      - name: Verify Go SDK builds
        working-directory: api/go
        run: |
          echo "üß™ Testing Go SDK compilation..."
          go mod tidy
          go build ./...
          echo "‚úì Go SDK compiles successfully"
          
      - name: Clone go-sdk-temp repository
        run: |
          echo "üì• Cloning go-sdk-temp repository..."
          git clone https://x-access-token:${{ secrets.SDK_DEPLOY_GIT_TOKEN }}@github.com/flexprice/go-sdk-temp.git /tmp/go-sdk
          echo "‚úì Repository cloned"
          
      - name: Copy SDK files to go-sdk-temp
        run: |
          echo "üìÅ Copying SDK files..."
          
          cd /tmp/go-sdk
          
          # Remove old files (except .git)
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          
          # Copy SDK files
          cp -r $GITHUB_WORKSPACE/api/go/* /tmp/go-sdk/
          
          # Copy LICENSE
          if [ -f "$GITHUB_WORKSPACE/LICENSE" ]; then
            cp $GITHUB_WORKSPACE/LICENSE /tmp/go-sdk/
          fi
          
          echo "‚úì Files copied"
          
      - name: Commit and push to go-sdk-temp
        run: |
          cd /tmp/go-sdk
          
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Check for changes
          if [ -z "$(git status --porcelain)" ]; then
            echo "‚ö†Ô∏è No changes to commit"
            exit 0
          fi
          
          # Stage and commit
          git add .
          git commit -m "Release Go SDK v${{ env.VERSION }}"
          
          # Create tag
          git tag -a "v${{ env.VERSION }}" -m "Go SDK version ${{ env.VERSION }}"
          
          # Push
          git push origin main
          git push origin "v${{ env.VERSION }}"
          
          echo "‚úÖ Go SDK v${{ env.VERSION }} published successfully!"
          echo "üîó Repository: https://github.com/flexprice/go-sdk-temp"
          echo "üè∑Ô∏è Tag: v${{ env.VERSION }}"
          
      - name: Summary
        if: success()
        run: |
          echo "## ‚úÖ Go SDK Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** https://github.com/flexprice/go-sdk-temp" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** v${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "go get github.com/flexprice/go-sdk-temp@v${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

